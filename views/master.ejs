<% include ./common/header %>
<div class="container chat">
    <div class="chat-top">
        <div class="chat-top-left">
            <a onClick="showMasterInfo()" href="javascript:void(0)" class="hospital-logo">
                <img src="<% if(!datas.wxImage){%>/images/hospital.png<%}else{%><%=datas.wxImage %><%}%>" class="chat-titleImg">
                <%=datas.wxName%>
            </a>
        </div>
        华侨医院－药师患者沟通平台<a href="/login" class="exit">退出</a>
    </div>
    <div class="chat-content">
        <div class="chat-content-left">
            <div class="chat-list">
                <!--<% getFriends.forEach(function(item,i){%>-->
                    <!--<div class="list-item <% if(i==0){%>active<%}%>" id="<%= item._id%>">-->
                        <!--<img src="<%= item.wxImage%>" onClick="showUserInfo()" class="list-img">-->
                        <!--<div class="list-item-content">-->
                            <!--<div class="user"><span class="user-name"><%= item.wxName%></span> <span class="chat-time">上午11:32</span></div>-->
                            <!--<div class="newInfo"></div>-->
                        <!--</div>-->
                    <!--</div>-->
                <!--<%})%>-->
                <!--<div class="list-item active">
                    <img src="/images/user.png" onClick="showUserInfo()" class="list-img">
                    <div class="list-item-content">
                        <div class="user"><span class="user-name">刘患者</span> <span class="chat-time">上午11:32</span></div>
                        <div class="newInfo">您好，我想咨询一下用药的问题…</div>
                    </div>
                </div>-->
            </div>
        </div>
        <div class="chat-content-right">
            <div class="chat-content-right-top">
                <div class="chatContent">
                    <!-- <div class="chatContent-box chatContent-left">
                         <a href="javascript:void(0)" class="chatContent-logo user-logo">
                             <img src="/images/user.png" class="chatContent-img">
                         </a>
                         <div class="chatContent-content">
                             <span class="chatContent-text">您好，从专业角度出发，为避免信息缺失造成风险管理遗漏，请您在个人中心完善资料，方便药师了解您的基础健康信息。</span>
                         </div>
                     </div>
                     <div class="chatContent-box chatContent-right">
                         <a href="javascript:void(0)" class="chatContent-logo hospital-logo">
                             <img src="/images/hospital.png" class="chatContent-img">
                         </a>
                         <div class="chatContent-content">
                             <span class="chatContent-text">您好，从专业角度出发，为避免信息缺失造成风险管理遗漏，请您在个人中心完善资料，方便药师了解您的基础健康信息。</span>
                             <a class="chatContent-link">
                                 <img src="/images/icon-arrow.png" class="icon-arrow">关注微信公众号
                             </a>
                            <a class="chatContent-link">
                                <img src="/images/icon-arrow.png" class="icon-arrow">完善个人资料
                            </a>
                        </div>
                    </div>-->
                </div>
                <div class="popup hospital-popup">
                    <div class="popup-top">
                        <img src="/images/icon-close.png" class="popup-close">
                        <span class="popup-edit">编辑</span>
                    </div>
                    <div class="popup-content master-popup">
                        <div class="popup-item QRcode">
                            <div class="popup-item-left QRcode-text">二维码</div>
                            <div class="popup-item-right">
                                <img src="<%= qrcode%>" class="QRcode-img">
                            </div>
                        </div>
                        <div class="popup-item">
                            <div class="popup-item-left">登录账号</div>
                            <div class="popup-item-right phone"><%=datas.phone%></div>
                        </div>
                        <div class="popup-item">
                            <div class="popup-item-left">服务人次</div>
                            <div class="popup-item-right"><span class="serviceNum">无</span>人</div>
                        </div>
                        <div class="popup-item">
                            <div class="popup-item-left">服务评分</div>
                            <div class="popup-item-right gradeNum"><%=datas.star%> <img src="/images/icon-star-active.png" class="icon-star"></div>
                        </div>
                        <div class="popup-item gender">
                            <div class="popup-item-left">性别</div>
                            <div class="popup-item-right gender-text"><% if(datas.sex == 0){%>男<%}else {%>女<%}%></div>
                            <div  class="popup-item-right gender-selects">
                                <div class="select" name=1>男</div>
                                <div class="select active" name=0>女</div>
                            </div>
                        </div>
                        <div class="popup-item">
                            <div class="popup-item-left">单位</div>
                            <div class="popup-item-right"><input class="popup-input unit" type="text" value="无" placeholder="请输入您的单位" disabled></div>
                        </div>
                        <div class="popup-item">
                            <div class="popup-item-left">职称</div>
                            <div class="popup-item-right">
                                <div class="popup-item-right"><input class="popup-input jobTitle" type="text" value="无" placeholder="请输入您的职称" disabled></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="popup user-popup">
                    <div class="popup-top">
                        <img src="/images/icon-close.png" class="popup-close">
                    </div>
                    <div class="popup-content">
                        <div class="popup-item">
                            <div class="popup-item-left"><img src="/images/user.png" class="user-img"></div>
                            <div class="popup-item-right user-name">微信号</div>
                        </div>
                        <div class="popup-item">
                            <div class="popup-item-left">手机号码</div>
                            <div class="popup-item-right phone">无</div>
                        </div>
                        <div class="popup-item">
                            <div class="popup-item-left">真实姓名</div>
                            <div class="popup-item-right name">无</div>
                        </div>
                        <div class="popup-item">
                            <div class="popup-item-left">性别</div>
                            <div class="popup-item-right sex">女</div>
                        </div>
                        <div class="popup-item">
                            <div class="popup-item-left">住院号</div>
                            <div class="popup-item-right hospitalId">无</div>
                        </div>
                        <div class="popup-item">
                            <div class="popup-item-left">诊疗卡号</div>
                            <div class="popup-item-right hospitalcradId">无</div>
                        </div>
                        <div class="popup-item note">
                            <div class="popup-item-left">备注</div>
                            <div class="popup-item-right">
                                <input type="text" class="note-input mark" placeholder="请输入备注" value="无" disabled>
                                <img src="/images/icon-edit.png" class="icon-edit">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="sendInfo">
                <div class="sendInfo-toolbar">
                    <div class="sendEvaluation">发送评价请求</div>
                </div>
                <textarea name="" id="message" class="sendInfo-content"></textarea>
                <div class="btn-sendInfo" onClick="sendMasterMessage()">发送</div>
            </div>
        </div>
    </div>
</div>
    <script>
        //更新左侧用户列表
        function upUserList(list){
            return  fetch('/userList/<%=datas._id%>?ids='+JSON.stringify(list),{
                  method:'GET'
              }).then(function(result){
                  return result.json();
              }).then(function(result){
                  if(result.statu == 1){
                    var item="";
                      $(result.datas).each(function(index,ele){
                          if(ele._id != '<%=datas._id%>'){
                              item += '<div onClick="chatList(this)" class="list-item" id='+ele._id+'>';
                              item +=' <img src='+ele.wxImage+' onClick="showUserInfo()" class="list-img">';
                              item +='<div class="list-item-content"><div class="user"><span class="user-name">'+ele.wxName+'</span>';
                              if(!!ele.lastMessage){
                                  item += '<span class="chat-time">'+(ele.lastMessage.date[0] == "pm"?"下午":"上午")+ele.lastMessage.date[1]+'</span>';
                              }
                              item +='</div>';
                              if(!!ele.lastMessage){
                                  item +='<div class="newInfo">'+ele.lastMessage.message+'</div>' ;
                              }
                              item +=' </div></div>';
                          }
                      })
                    $('.chat-list').html(item);
                    $('.chat-list .list-item').first().addClass("active")
              }
            })
      }

        function getUserInfo(id){
            console.log(id)
            fetch('/getUserInfo/'+id,{
                method:'GET'
            }).then(function(result){
                return result.json();
            }).then(function(result){
                console.log(result,"sss")
                if(result.statu == 1){
                    $(".user-popup .user-img").attr("src",result.datas.wxImage);
                    $(".user-logo .chatContent-img").attr("src",result.datas.wxImage);
                    $(".user-popup .hospitalId").text(result.datas.hospitalId || "无");
                    $(".user-popup .hospitalcradId").text((!!result.datas.crads.length) ? result.datas.crads[0].id:"无");
                    $(".user-popup .user-name").text(result.datas.wxName || "无");
                    $(".user-popup .name").text(result.datas.name || "无");
                    $(".user-popup .sex").text(result.datas.sex == 0 ? "女" :"男")
                    $(".user-popup .phone").text(result.datas.phone || "无");
                    $(".note .mark").val(result.datas.mark || "无");
                }
            })
        }
        function getMasterInfo(id){
            fetch('/getUserInfo/'+id,{
                method:'GET'
            }).then(function(result){
                return result.json();
            }).then(function(result){
                if(result.statu == 1){
                    $(".hospital-popup .phone").text(result.datas.phone || "无");
                    $(".hospital-popup .serviceNum").text(!!(result.datas.friends.length)?result.datas.friends.length:0);
                    $(".hospital-popup .gradeNum").text(result.datas.gradeNum);
                    $(".hospital-popup .unit").val(result.datas.unit || "无");
                    $(".hospital-popup .jobTitle").val(result.datas.jobTitle || "无");
                }
            })
        }
        function getToken(){
            return fetch('/token/master/<%=datas.phone%>/<%=datas.password%>',{method:'GET'}).then(function(result){
                        return result.json();
                    })
        }
        var socket,id="<%=datas._id%>";
        function connect(){
            if(!!socket){
//                alert('您已经加入了聊天!')
                return;
            }
            //监听验证权限事件
            getToken().then(function(result){
                console.log(result)
                if(result.statu === 0){
                    return alert(result.msg);
                }
                socket = io.connect('http://socket1.immo.cn',{path:'/socket'});
                 //console.log(socket);

                socket.on('error',function(error){
                    console.log(error);
                });
                socket.on("unauthorized", function(error, callback) {
                    console.log(error);
                  if (error.data.type == "UnauthorizedError" || error.data.code == "invalid_token") {
                      callback();
                      console.log("token过期!");
                      socket = null;
                      connect();
                  }
                });

                socket.on('connect',function(){
                    console.log(socket);

//                    if(!!$(".chat-list .list-item").length){
//                        getHistoryMessage();
//                    }


                })
                socket.on('authenticated',function(){
                    //监听连接事件

                    socket.on('connectId',function(rid){
                        // alert('您的昵称为:'+message.info);
                        id = rid;
                    });
                    //监听消息
                    socket.on('messages',function(message){
                        console.log(message,'您收到来自'+message.from+'的消息:'+message.info);
                        if($(".chat-list .active").attr("id") == message.user._id){
                            var dialog="";
                            dialog+='<div class="chatContent-box chatContent-left"><a onClick="showUserInfo()" href="javascript:void(0)" class="chatContent-logo user-logo">';
                            dialog+='<img src='+message.user.image+' class="chatContent-img">';
                            dialog+= '</a> <div class="chatContent-content"> <span class="chatContent-text">';
                            dialog+=   message.info;
                            dialog+= '</span> </div> </div>';
                            $('.chatContent').append(dialog);
                            $('.chatContent').scrollTop($('.chatContent')[0].scrollHeight);
                        }else{
//                            alert("sss")
                        }
                    })

                    //监听重新连接事件
                    socket.on('reconnect',function(){
                        console.log('断线重连!');
                    })
                    //超时
                    socket.on('connect_timeout', function(timeout){
                        console.log()
                    });
                    //下线
                    socket.on('disconnect', function(message) {
                        console.log(message,"sss")
                    });
                    //监听其他用户登录事件

                    socket.on('otherConnect',function(message){
                        console.log(message);
                    })

                    //监听用户列表事件

                    socket.on('userList',function(list){
                        fetch('/getUserInfo/<%=datas._id%>',{
                            method:'GET'
                        }).then(function(result){
                            return result.json();
                        }).then(function(result){
                            if(result.statu == 1){
                                upUserList(result.datas.friends).then(function(){
                                    getHistoryMessage();
                                })
                            }
                    })

                    });


                    //监听离线消息事件
                    socket.on('offLineMessage',function(list){
//                        alert(list.length);
                    })
                })
                socket.emit('authenticate',{token:result.datas})
            })




        }

        function sendMasterMessage(type){
            var _m;
            _m = $(".sendInfo-content").val();
            if(!type && _m == ''){
                return false;
            }
            if(!socket){
//                alert('还没有建立连接呢亲爱的!')
                return ;
            }
            if(!!type){
                _m = 'close';
            }

            socket.emit('message',{to:$(".chat-list .active").attr("id"),info:_m},function(result){
                console.log(result)
                if(result){
                    var dialog="";
                    if(_m == 'close'){
                        dialog +='<div class="chatContent-box chatContent-right"><a onClick="showMasterInfo()" href="javascript:void(0)" class="chatContent-logo hospital-logo"> <img src="/images/hospital.png" class="chatContent-img"> </a> <div class="chatContent-content"> <span class="chatContent-text">' ;
                        dialog += '感谢您的咨询！希望我们的服务能解决您的问题。赶紧去给黄药师的服务评分吧！';
                        dialog += ' <a class="chatContent-link"> <img src="/images/icon-arrow.png" class="icon-arrow">去评分</a></span> </div> </div>';
                    }else{
                        dialog+='<div class="chatContent-box chatContent-right"><a onClick="showMasterInfo()" href="javascript:void(0)" class="chatContent-logo hospital-logo">';
                        dialog+='<img src="<% if(!datas.wxImage){%>/images/hospital.png<%}else{%><%=datas.wxImage %><%}%>" class="chatContent-img">';
                        dialog+= '</a> <div class="chatContent-content"> <span class="chatContent-text">';
                        dialog+=   document.getElementById('message').value;
                        dialog+= '</span> </div> </div>'
                    }
                    $('.chatContent').append(dialog);
                    $('.chatContent').scrollTop($('.chatContent')[0].scrollHeight);
                    $(".sendInfo-content").val("")
//                    alert(result);
                }
            })
        }


        //获取与当前人员的聊天记录
        function getHistoryMessage(to){
            var to = to || $(".chat-list .active").attr("id");
            if(!id){
//                alert('您暂时还没连接!')
                return;
            }
            fetch(`/history?from=<%=datas._id%>&to=${to}`,{method:'GET'})
                .then(function(result){
                    return result.json()
                })
                .then(function(result){
                        console.log(result)
                    if(result.statu === 0){
                        return alert(result.msg);
                    }else{
                        return result;
                    }
                })
                .then(function(result){
                    if(result.datas.length == 0) return ;
                    var dialog="";
                    $(result.datas).each(function(index,ele){
                        if('<%=datas._id%>' == ele.from){
                            if(ele .message == "close"){
                                dialog +='<div class="chatContent-box chatContent-right"><a onClick="showMasterInfo()" href="javascript:void(0)" class="chatContent-logo hospital-logo"> <img src="/images/hospital.png" class="chatContent-img"> </a> <div class="chatContent-content"> <span class="chatContent-text">' ;
                                dialog += '感谢您的咨询！希望我们的服务能解决您的问题。赶紧去给黄药师的服务评分吧！';
                                dialog += ' <a class="chatContent-link"> <img src="/images/icon-arrow.png" class="icon-arrow">去评分</a></span> </div> </div>';
                            }else{
                                dialog+='<div class="chatContent-box chatContent-right"><a onClick="showMasterInfo()" href="javascript:void(0)" class="chatContent-logo hospital-logo">';
                                dialog+='<img src="<% if(!datas.wxImage){%>/images/hospital.png<%}else{%><%=datas.wxImage %><%}%>" class="chatContent-img">';
                                dialog+= '</a> <div class="chatContent-content"> <span class="chatContent-text">';
                                dialog+=   ele .message;
                                dialog+= '</span> </div> </div>';
                            }
                        }else{
                            dialog+='<div class="chatContent-box chatContent-left"><a onClick="showUserInfo()" href="javascript:void(0)" class="chatContent-logo user-logo">';
                            dialog+='<img src="/images/user.png" class="chatContent-img">';
                            dialog+= '</a> <div class="chatContent-content"> <span class="chatContent-text">';
                            dialog+=   ele .message;
                            dialog+= '</span> </div> </div>';
                        }
                    })
                    $('.chatContent').html(dialog);
                    $('.chatContent').scrollTop($('.chatContent')[0].scrollHeight);
                    return "";
                }) .then(function(){
                    if(!!$(".chat-list .active").attr("id")){
                        getUserInfo($(".chat-list .active").attr("id"));
                    }
            })
        }
        connect();
    </script>
    <script>
   function chatList(e) {
        if ($(e).hasClass("active")) return false;
        getHistoryMessage($(e).attr("id"),1);
        $(e).addClass("active").siblings().removeClass("active");
    }
    function showMasterInfo() {
        getMasterInfo(id);
        $(".hospital-popup").show();
    }
    $(".popup-close").click(function () {
        $(this).parents(".popup").hide();
    });
    function showUserInfo() {
        getUserInfo($(".chat-list .active").attr("id"));
        $(".user-popup").show();
    };
    $(".icon-edit").click(function () {
        getUserInfo($(".chat-list .active").attr("id"));
        $('.note-input').attr("disabled",false);
        $('.note-input').select();
    });
    $('.note-input').blur(function(){
        fetch('/editUserInfo/'+$(".chat-list .active").attr("id"), {
            method:'POST',
            body: JSON.stringify({
                id:$(".chat-list .active").attr("id"),
                phone: $(".user-popup .phone").text(),
                name:$(".user-popup .name").text(),
                sex:$(".user-popup .sex").text() == "女" ? 0 :1,
                hospitalId:$(".user-popup .hospitalId").text(),
                mark: $(".user-popup .mark").val()
        }),
            headers:{
                'Accept':'application/json',
                'Content-Type':'application/json'
            }
        }).then(function(result){
                return result.json();
        }).then(function(result){
                if(result.statu == 1){
                    $('.note-input').attr("disabled",true);
                }
        })
    })
    $(".popup-edit").click(function () {
        if( $('.hospital-popup .popup-input').attr("disabled") == "disabled"){
            $('.hospital-popup .popup-input').attr("disabled",false);
            $('.hospital-popup .popup-input').first().select();
            $('.hospital-popup .popup-input').addClass("active-input");
            $('.gender .gender-text').hide();
            $('.gender .gender-selects').css("display","inline-block");
            $(".popup-edit").text("保存");
        }else{
            fetch('/editMasterInfo/'+id, {
                method:'POST',
                body: JSON.stringify({
                    id:id,
                    sex:$(".gender-selects .active").attr("name"),
                    unit:$(".unit").val(),
                    jobTitle:$(".jobTitle").val()
                }),
                headers:{
                    'Accept':'application/json',
                    'Content-Type':'application/json'
                }
            }).then(function(result){
                    return result.json();
                }).then(function(result){
                    if(result.statu == 1){
                    $('.gender .gender-text').text( $('.gender-selects .active').text()).show();
                    $('.gender .gender-selects').hide();
                    $('.hospital-popup .popup-input').attr("disabled",true);
                    $('.hospital-popup .popup-input').removeClass("active-input");
                    $(".popup-edit").text("编辑");
                }
            })
        }
    });
    $(".gender-selects .select").click(function () {
        if ($(this).hasClass("active")) return false;
        $(this).addClass("active").siblings().removeClass("active");
    });
    $(".sendEvaluation").click(function(){
        sendMasterMessage("close")
    })
</script>
<% include ./common/footer %>
